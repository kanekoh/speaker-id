<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è©±è€…ç™»éŒ²</title>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f2f2f2; }
    h1 { color: #333; }
    label, input, button { display: block; margin: 1em 0; }
    #status { margin-top: 1em; font-weight: bold; }
  </style>
</head>
<body>
  <h1>è©±è€…ç™»éŒ²</h1>

  <label for="nameInput">è­˜åˆ¥åï¼ˆåŠè§’è‹±æ•°å­—ï¼‰:</label>
  <input type="text" id="nameInput" placeholder="ä¾‹: tanaka">

  <label for="kanaInput">è¡¨ç¤ºåï¼ˆã²ã‚‰ãŒãªã‚„æ¼¢å­—ãªã©ï¼‰:</label>
  <input type="text" id="kanaInput" placeholder="ä¾‹: ãŸãªã‹ã•ã‚“">

  <button id="recordButton">ğŸ™ï¸ éŒ²éŸ³é–‹å§‹</button>

  <p>ä»¥ä¸‹ã®æ–‡ã‚’èª­ã¿ä¸Šã’ã¦ãã ã•ã„ï¼š</p>
  <p id="sampleText">ã“ã‚“ã«ã¡ã¯ã€‚ç§ã¯ã€‡ã€‡ã§ã™ã€‚ã‚¹ã‚¿ãƒƒã‚¯ãƒãƒ£ãƒ³ã«å£°ã‚’ç™»éŒ²ã—ã¾ã™ã€‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚</p>

  <button id="stopButton" disabled>â¹ï¸ éŒ²éŸ³çµ‚äº†</button>
  <button id="uploadButton" disabled>â¬†ï¸ ç™»éŒ²ã—ã¦é€ä¿¡</button>

  <p id="status">çŠ¶æ…‹: å¾…æ©Ÿä¸­</p>

  <a href="/test.html">â†’ è©±è€…è­˜åˆ¥ãƒ†ã‚¹ãƒˆã¸</a>

  <!-- ã©ã“ã‹åˆ†ã‹ã‚Šã‚„ã™ã„å ´æ‰€ã«è¨­ç½® -->
  <button id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

  <script src="/static/auth.js"></script>
  <script>
    let mediaRecorder;
    let recordedChunks = [];


    // --- éŒ²éŸ³ãƒ»é€ä¿¡ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãã§é€ä¿¡ï¼‰ ---
    const recordBtn = document.getElementById("recordButton");
    const stopBtn = document.getElementById("stopButton");
    const uploadBtn = document.getElementById("uploadButton");
    const status = document.getElementById("status");

    // --- èªè¨¼ï¼ˆauth.jsï¼‰ ---
    window.onload = function () {
      Auth.ensureToken();
    };

    document.getElementById("logoutBtn").onclick = function() {
      Auth.logout();
      // location.reload(); // å¿…è¦ã«å¿œã˜ã¦æœ‰åŠ¹åŒ–
    };

    recordBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      recordedChunks = [];

      mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
      mediaRecorder.onstop = () => {
        status.textContent = "éŒ²éŸ³çµ‚äº†";
        uploadBtn.disabled = false;
      };

      mediaRecorder.start();
      status.textContent = "éŒ²éŸ³ä¸­...";
      recordBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      recordBtn.disabled = false;
      stopBtn.disabled = true;
    };

    uploadBtn.onclick = async () => {
      const name = document.getElementById("nameInput").value.trim();
      const kana = document.getElementById("kanaInput").value.trim();

      if (!name) {
        alert("è­˜åˆ¥åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      const blob = new Blob(recordedChunks, { type: 'audio/wav' });
      const formData = new FormData();
      formData.append("audio", blob, name + ".wav");
      formData.append("name", name);
      formData.append("kana", kana);

      status.textContent = "é€ä¿¡ä¸­...";
      try {
        const res = await Auth.authFetch("/register", {
          method: "POST",
          body: formData
        });
        const result = await res.json();
        if (res.ok) {
          status.textContent = `ç™»éŒ²æˆåŠŸ: ${result.kana}ï¼ˆID: ${result.name}ï¼‰`;
        } else {
          status.textContent = "èªè¨¼ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ç™»éŒ²å¤±æ•—";
        }
      } catch (e) {
        console.error(e);
        status.textContent = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
      }
    };
  </script>
</body>
</html>
